<!DOCTYPE html>
<html lang="en">

<head>
	<title>Kai Evans in writing</title>
	<meta charset="utf-8" />
	<link rel="icon" href="../../favicon.png" />
	<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<script>
		const storedTheme =
			typeof localStorage !== "undefined"
				? localStorage.getItem("theme")
				: null;

		const prefersDark = window.matchMedia(
			"(prefers-color-scheme: dark)"
		).matches;

		if (storedTheme === "dark" || (!storedTheme && prefersDark)) {
			document.documentElement.classList.add("dark");
		}
	</script>
	<meta http-equiv="content-security-policy" content="">
		<link href="../../_app/immutable/assets/_layout-26efa887.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/_page-5c045b07.css" rel="stylesheet">
		<link rel="modulepreload" href="../../_app/immutable/start-7b8fd23b.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/index-920be987.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/singletons-59e463da.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/preload-helper-41c905a7.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/control-e7f5239e.js">
		<link rel="modulepreload" href="../../_app/immutable/components/pages/_layout.svelte-45a685b0.js">
		<link rel="modulepreload" href="../../_app/immutable/modules/pages/_layout.ts-9cbb603b.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/_layout-da46b06b.js">
		<link rel="modulepreload" href="../../_app/immutable/components/pages/posts/_...slug_/_page.svelte-df4f18c3.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/Date-75465d9b.js">
		<link rel="modulepreload" href="../../_app/immutable/modules/pages/posts/_...slug_/_page.ts-9f45be1f.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/index-4d8f42c1.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/posts-352cc89b.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/_page-6c8e9c8c.js"><title>The journey to Cilium and back ⁍ Kai Evans</title><!-- HEAD_svelte-1ijfm1m_START --><meta name="title" content="The journey to Cilium and back ⁍ Kai Evans"><meta name="description" content="Documenting my experience with cilium networking stack in my homelab"><meta name="author" content="Kai Evans"><meta property="og:type" content="article"><meta property="og:title" content="The journey to Cilium and back ⁍ Kai Evans"><meta property="og:description" content="Documenting my experience with cilium networking stack in my homelab"><meta property="og:url" content="http://kaievans.co/posts/tech/cilium-there-and-back"><meta property="og:site_name" content="Kai Evans in writing"><meta property="og:image" content="/_app/immutable/assets/cilium-splash-6578d797.png"><meta property="og:image:width" content="761"><meta property="og:image:height" content="555"><meta property="article:author" content="Kai Evans"><meta property="article:published_time" content="2025-03-09T13:00:00.000Z"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="http://kaievans.co/posts/tech/cilium-there-and-back"><meta property="twitter:title" content="The journey to Cilium and back ⁍ Kai Evans"><meta property="twitter:description" content="Documenting my experience with cilium networking stack in my homelab"><meta property="twitter:image" content="/_app/immutable/assets/cilium-splash-6578d797.png"><!-- HEAD_svelte-1ijfm1m_END -->
</head>

<body data-sveltekit-preload-data="hover">
	<div style="display: contents;">


<header class="group relative mb-12 flex items-center sm:pl-[4.5rem]"><div class="flex sm:flex-col"><a href="/" class="inline-flex items-center sm:relative sm:inline-block" aria-current="page"><img src="/_app/immutable/assets/face-6c9b604a.webp" class="w-14 h-14 rounded mr-3 sm:absolute sm:left-[-4.5rem] sm:mr-0" alt="Kai Evans face">
            <span class="text-xl font-bold sm:text-2xl">Kai Evans</span></a>

        <nav class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-[color:var(--theme-menu-bg)] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:mt-1 sm:-ml-4 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dotted sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none" aria-label="Main menu"><a href="/" class="py-4 px-4 sm:py-0 sm:hover:underline" aria-current="page" rel="prefetch">Home</a>
            <a href="/about" class="py-4 px-4 sm:py-0 sm:hover:underline" aria-current="false" rel="prefetch">About</a>
            <a href="/posts" class="py-4 px-4 sm:py-0 sm:hover:underline" aria-current="false" rel="prefetch">Log</a></nav></div>
    <button type="button" class="group relative ml-auto h-9 w-9 rounded-md bg-zinc-200 p-2 ring-zinc-400 transition-all hover:ring-2 dark:bg-zinc-700" aria-label="Toggle Dark Mode"><svg id="sun-svg" class="absolute top-1/2 left-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all group-aria-pressed:scale-100 group-aria-pressed:opacity-100" aria-hidden="true" focusable="false" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    <svg id="moon-svg" class="absolute top-1/2 left-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all group-aria-[pressed=false]:scale-100 group-aria-[pressed=false]:opacity-100" aria-hidden="true" focusable="false" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"></circle><path d="M7.63262 3.06689C8.98567 3.35733 9.99999 4.56025 9.99999 6.00007C9.99999 7.65693 8.65685 9.00007 6.99999 9.00007C5.4512 9.00007 4.17653 7.82641 4.01685 6.31997" stroke="currentColor" stroke-width="1.5"></path><path d="M22 13.0505C21.3647 12.4022 20.4793 12 19.5 12C17.567 12 16 13.567 16 15.5C16 17.2632 17.3039 18.7219 19 18.9646" stroke="currentColor" stroke-width="1.5"></path><path d="M14.5 8.51L14.51 8.49889" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M10 17C11.1046 17 12 16.1046 12 15C12 13.8954 11.1046 13 10 13C8.89543 13 8 13.8954 8 15C8 16.1046 8.89543 17 10 17Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></header>

<main><article>
    
    
    
    

    <h1 class="title">The journey to Cilium and back</h1>
<time datetime="2025-03-09T13:00:00.000Z" class="">10 March 2025</time>

<div class="inline before:content-['|']"><svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" class="inline-block h-6 w-6 ml-1" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path><path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path><path d="M6 9h-.01"></path></svg>
        <a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag technology" href="/tags/technology">technology</a>, <a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag kubernetes" href="/tags/kubernetes">kubernetes</a>, <a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag homelab" href="/tags/homelab">homelab</a>, <a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag linux" href="/tags/linux">linux</a>, <a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag networks" href="/tags/networks">networks</a></div>

    <div class="mt-8 prose prose-sm prose-cactus prose-headings:font-semibold prose-headings:before:absolute prose-headings:before:-ml-4 prose-headings:before:text-accent prose-headings:before:content-['#'] prose-th:before:content-none"><p>I have spent the last month and a half tinkering with <a href="https://github.com/cilium/cilium" rel="nofollow">cilium</a> in my homelab. I took it through two different linux distros, four kubernetes flavours and probably a few hundreds of actual cluster deployments in various configurations. And now documenting it seems like a good idea.</p>
<h2 id="what-is-cilium"><a aria-hidden="true" tabindex="-1" href="#what-is-cilium"><span class="icon icon-link"></span></a>What is Cilium?</h2>
<p>I wrote about cilium a few weeks ago when i started pocking at it. But the long story short, it is a network stack designed specifically for containerised/distributed environments. Although calling it that is probably wrong, so let me unpack it a little bit.</p>
<figure class="rehype-figure"><img src="/_app/immutable/assets/cilium-ec719e20.webp" alt="Curtesy of cilium official docs"><figcaption>Curtesy of cilium official docs</figcaption></figure>
<p>From the nuts and bolts perspective, cilium is basically a eBPF module that sits in linux kernel and it manages network traffic <em>in its entirety</em> between “physical” network interfaces and containers directly.</p>
<p>And eBPF is basically a low level bytecode VM that runs directly in the linux kernel. What it all boils down to is cilium generating that kernel bytecode from all sorts of configurations and then running the network in one place. In a way it’s simple but the implications are more than significant.</p>
<h2 id="what-cilium-actually-do"><a aria-hidden="true" tabindex="-1" href="#what-cilium-actually-do"><span class="icon icon-link"></span></a>What Cilium actually do</h2>
<p>At a first glance, what cilium does might seem counter intuitive and even anti-linux in some ways. In a “normal” linux server setup there are all sorts of moving parts to the network stack: iptables, netstat, firewalls, etc. And then when we add containers into the mix there is the containers networking interfaces (CNI). And in case of Kubernetes there is also cluster routing, RBACs, proxying, and more. And on top of that, you might be looking at cross-cluster meshes and what’s not.</p>
<p>Cilium aims to basically replace all of that with just one piece of software, one kernel module. It wants to own the entire network stack from L2 to L7 and everything in between; including your host network management and the firewall. It’s like one monolithic tool that does it all. And that’s what i meant when i said that it seems a bit anti-unix from a philosophical perspective.</p>
<p>And so, the question that kept bugging me at the beginning was <em>“why would you want to do that?”</em> why move away from a set of small well tested and replaceable tools to a monolith? And more importantly why would you want to manage the <em>host network from a container?</em> shouldn’t it be the other way around?</p>
<h2 id="the-rationale-behind-cilium"><a aria-hidden="true" tabindex="-1" href="#the-rationale-behind-cilium"><span class="icon icon-link"></span></a>The rationale behind Cilium</h2>
<p>There are definitely network performance improvements by handling everything in one place. There are no handovers and everything runs in the kernel. In a large, facebook scale deployments that is probably significant, but in a homelab context it won’t even register.</p>
<p>There is also the appeal of having one tool for everything. And that what had initially drawn me to cilium. Being able to setup everything from L2 IP announcements to L7 ingress routing in one tool seemed neat and appealing. But, in practical terms it doesn’t make a whole lot of difference in the day to day. Because although cilium is what powers your manifests in the background, these are still the same exact kubernetes standard manifests. And from that perspective its as good as any other tool.</p>
<p>As obvious as these points are, I think they are the wrong lens to look at it though. I think the better way to look at cilium is large scale fully containerised environments. As in hundreds of nodes per cluster that run nothing but containers.</p>
<p>I think in the context of a “traditional” somewhat manually built small app server there is not much of a difference between using more “normal” tools and cilium. You’ll just swap one type of configs to another.</p>
<p>In a large container first environment though, it makes a whole lot of sense to have the entirety of the network stack to come from control plane and be observable through and through in one place. It is definitely possible to automate iptables, firewalls, and all in a 1000 nodes cluster through something like terraform, but it won’t be as robust and manageable as a centralised cilium based network management.</p>
<p>And from that perspective of large scale cloud networks engineering I think cilium is actually quite spectacular.</p>
<h2 id="what-was-my-experience-like"><a aria-hidden="true" tabindex="-1" href="#what-was-my-experience-like"><span class="icon icon-link"></span></a>What was my experience like?</h2>
<p>In the past 6 weeks or so, I installed cilium in all sorts of setups. Ubuntu, and fedora server. Vanilla k8s, k3s, k0s, microk8s. Normal HTTP/s apps, tcp workloads, network security roles, host firewalls, l2 ARP net IP announcements, everything I could figure how to work with.</p>
<p>And in most cases it just works. It is shipped as a helm chart, and the installation process is mostly straight forward actually. The most complicated part was stripping down kubernetes itself to remove cluster routing, CNI, kube-proxy and all of that, and in different kubernetes distributions it can be a little tricky to achieve.</p>
<p>Cilium also comes with very good observability tooling and a simple UI where one can see visually how everything is tied together and observe the traffic and API calls; which is fantastic. The Prometheus/Graphana integration is top notch too.</p>
<p>It definitely becomes a bit complicated if you try to mix and match things with cilium. Like for example trying to pair it with host firewall took me onto all sorts of spelunking journeys.</p>
<p>Also I have experienced issues with L2 IP announcements and leases which was less than ideal. But these are <em>me</em> problems, i think more experienced engineers would have less of an issue with these.</p>
<h2 id="why-i-moved-away-from-it"><a aria-hidden="true" tabindex="-1" href="#why-i-moved-away-from-it"><span class="icon icon-link"></span></a>Why I moved away from it</h2>
<p>Eventually though, I actually decided against cilium and went back to a more standard metallb, flannel, and traefik setup. And the reason has less to do with cilium and more to do with what I need.</p>
<p>The thing about cilium is that it is designed for cloud network engineers, and I’m not that. I’m mostly an app developer, and i only pretend play a sys admin. Cilium does everything up to the app level very well, and even though it has all the standard ingress and port mapping implemented, it is much less useful to me than traefik for example.</p>
<p>I have no interest in setting up network traffic policies and write hundreds of lines of firewall manifests to secure my cluster. Those are all cool things to work with, but what i need is different. I need reusable middleware to authenticate and redirect and whitelist http calls. I need simple traffic routing tools so i could connect IPs to services. More specifically I work with TCP/UDP protocols a fair bit, and cilium doesn’t support TCP routing and I’d have to stick to vanilla loadbalancers or node ports for those.</p>
<p>I have a history of maintaining and troubleshooting metallb and traefik setups. And cilium doesn’t actually add a whole lot for me personally (although I really like hubble UI), if anything it subtracts from what traefik can offer.</p>
<p>Well that, and issues with L2 announcements stability, is what led me back to a familiar setup.</p>
<h2 id="take-away"><a aria-hidden="true" tabindex="-1" href="#take-away"><span class="icon icon-link"></span></a>Take away</h2>
<p>I really like Cilium, the idea of it, and the tools like hubble UI. And if i was running a proper production multi-tenant cluster, i’d even consider it as an option. But I don’t and so I didn’t.</p>
<p>Still, I have my reservations about the way they’re approaching the market. Networking is a hard problem and there is a reason why we have so much various tooling for different tasks. And if cilium aims to own everything it’s going to be difficult for it to compete with <em>everything</em> else. I don’t think that is sustainable.</p>
<p>Traefik vs Cilium is a good example here. Traefik is great from the app development perspective because it has a familiar and extensible middleware based architecture; where cilium is putting its bets with kubernetes native standards that naturally tend to lag behind the real world use cases. For example there is still no implemented concept of TCP routing in cilium. And so we’re almost looking at having both to get somewhere, but then it goes against the grain with Cilium “own everything in one place” ethos.</p>
<p>And i think this tension will continue hinder Cilium’s progress and adoption.</p>
<p>Or. I’m wrong about all of this. And in that case we’re all going to benefit from cilium’s success.</p></div></article></main>

<footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pt-20 pb-4 text-center align-top text-gray-500 sm:flex-row sm:justify-between sm:text-xs"><div class="mr-0 sm:mr-4">Copyright © 2025 Kai Evans
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500"><a href="/" class="px-4 py-2 sm:py-0 sm:px-2 sm:hover:text-textColor sm:hover:underline no-underline">Home</a>
        <a href="/about" class="px-4 py-2 sm:py-0 sm:px-2 sm:hover:text-textColor sm:hover:underline no-underline">About</a>
        <a href="/posts" class="px-4 py-2 sm:py-0 sm:px-2 sm:hover:text-textColor sm:hover:underline no-underline">Log</a></nav></footer>


		<script type="module" data-sveltekit-hydrate="1fsimk9">
			import { start } from "../../_app/immutable/start-7b8fd23b.js";

			start({
				assets: "",
				env: {},
				target: document.querySelector('[data-sveltekit-hydrate="1fsimk9"]').parentNode,
				version: "1746529959634",
				hydrate: {
					node_ids: [0, 6],
					data: [null,null],
					form: null,
					error: null
				}
			});
		</script>
	</div>
</body>

</html>