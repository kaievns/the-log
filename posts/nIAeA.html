<!DOCTYPE html>
<html lang="en">

<head>
	<title>Kai Evans in writing</title>
	<meta charset="utf-8" />
	<link rel="icon" href="../favicon.png" />
	<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<script>
		const storedTheme =
			typeof localStorage !== "undefined"
				? localStorage.getItem("theme")
				: null;

		const prefersDark = window.matchMedia(
			"(prefers-color-scheme: dark)"
		).matches;

		if (storedTheme === "dark" || (!storedTheme && prefersDark)) {
			document.documentElement.classList.add("dark");
		}
	</script>
	<meta http-equiv="content-security-policy" content="">
		<link href="../_app/immutable/assets/_layout-26efa887.css" rel="stylesheet">
		<link href="../_app/immutable/assets/_page-5c045b07.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/start-9d59f3a8.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index-920be987.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/singletons-59e463da.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/preload-helper-41c905a7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/control-e7f5239e.js">
		<link rel="modulepreload" href="../_app/immutable/components/pages/_layout.svelte-45a685b0.js">
		<link rel="modulepreload" href="../_app/immutable/modules/pages/_layout.ts-9cbb603b.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_layout-da46b06b.js">
		<link rel="modulepreload" href="../_app/immutable/components/pages/posts/_...slug_/_page.svelte-df4f18c3.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Date-75465d9b.js">
		<link rel="modulepreload" href="../_app/immutable/modules/pages/posts/_...slug_/_page.ts-fd8e1869.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index-4d8f42c1.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/posts-40dfc368.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_page-47935ce2.js"><title>How to make a svelte preprocessor ⁍ Kai Evans</title><!-- HEAD_svelte-1ijfm1m_START --><meta name="title" content="How to make a svelte preprocessor ⁍ Kai Evans"><meta name="description" content="A bit of a deep dive into Svelte plugins system"><meta name="author" content="Kai Evans"><meta property="og:type" content="article"><meta property="og:title" content="How to make a svelte preprocessor ⁍ Kai Evans"><meta property="og:description" content="A bit of a deep dive into Svelte plugins system"><meta property="og:url" content="http://kaievans.co/posts/nIAeA"><meta property="og:site_name" content="Kai Evans in writing"><meta property="og:image" content="/_app/immutable/assets/svelte-balls-81dbce81.jpeg"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="533"><meta property="article:author" content="Kai Evans"><meta property="article:published_time" content="2023-02-28T13:00:00.000Z"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="http://kaievans.co/posts/nIAeA"><meta property="twitter:title" content="How to make a svelte preprocessor ⁍ Kai Evans"><meta property="twitter:description" content="A bit of a deep dive into Svelte plugins system"><meta property="twitter:image" content="/_app/immutable/assets/svelte-balls-81dbce81.jpeg"><!-- HEAD_svelte-1ijfm1m_END -->
</head>

<body data-sveltekit-preload-data="hover">
	<div style="display: contents;">


<header class="group relative mb-12 flex items-center sm:pl-[4.5rem]"><div class="flex sm:flex-col"><a href="/" class="inline-flex items-center sm:relative sm:inline-block" aria-current="page"><img src="/_app/immutable/assets/face-6c9b604a.webp" class="w-14 h-14 rounded mr-3 sm:absolute sm:left-[-4.5rem] sm:mr-0" alt="Kai Evans face">
            <span class="text-xl font-bold sm:text-2xl">Kai Evans</span></a>

        <nav class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-[color:var(--theme-menu-bg)] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:mt-1 sm:-ml-4 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dotted sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none" aria-label="Main menu"><a href="/" class="py-4 px-4 sm:py-0 sm:hover:underline" aria-current="page" rel="prefetch">Home</a>
            <a href="/about" class="py-4 px-4 sm:py-0 sm:hover:underline" aria-current="false" rel="prefetch">About</a>
            <a href="/posts" class="py-4 px-4 sm:py-0 sm:hover:underline" aria-current="false" rel="prefetch">Log</a></nav></div>
    <button type="button" class="group relative ml-auto h-9 w-9 rounded-md bg-zinc-200 p-2 ring-zinc-400 transition-all hover:ring-2 dark:bg-zinc-700" aria-label="Toggle Dark Mode"><svg id="sun-svg" class="absolute top-1/2 left-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all group-aria-pressed:scale-100 group-aria-pressed:opacity-100" aria-hidden="true" focusable="false" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    <svg id="moon-svg" class="absolute top-1/2 left-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all group-aria-[pressed=false]:scale-100 group-aria-[pressed=false]:opacity-100" aria-hidden="true" focusable="false" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"></circle><path d="M7.63262 3.06689C8.98567 3.35733 9.99999 4.56025 9.99999 6.00007C9.99999 7.65693 8.65685 9.00007 6.99999 9.00007C5.4512 9.00007 4.17653 7.82641 4.01685 6.31997" stroke="currentColor" stroke-width="1.5"></path><path d="M22 13.0505C21.3647 12.4022 20.4793 12 19.5 12C17.567 12 16 13.567 16 15.5C16 17.2632 17.3039 18.7219 19 18.9646" stroke="currentColor" stroke-width="1.5"></path><path d="M14.5 8.51L14.51 8.49889" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M10 17C11.1046 17 12 16.1046 12 15C12 13.8954 11.1046 13 10 13C8.89543 13 8 13.8954 8 15C8 16.1046 8.89543 17 10 17Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></header>

<main><article>
    
    
    
    

    <h1 class="title">How to make a svelte preprocessor</h1>
<time datetime="2023-02-28T13:00:00.000Z" class="">1 March 2023</time>

<div class="inline before:content-['|']"><svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" class="inline-block h-6 w-6 ml-1" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path><path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path><path d="M6 9h-.01"></path></svg>
        <a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag svelte" href="/tags/svelte">svelte</a>, <a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag javascript" href="/tags/javascript">javascript</a></div>

    <div class="mt-8 prose prose-sm prose-cactus prose-headings:font-semibold prose-headings:before:absolute prose-headings:before:-ml-4 prose-headings:before:text-accent prose-headings:before:content-['#'] prose-th:before:content-none"><p>The other day I needed to do a bit of a weird thing in Svelte on this website,
and I ended up making a small preprocessor plugin. It’s a fun little project,
and I thought it’s worth sharing the details.</p>
<p>Before I start, an acknowledgement. I didn’t invent any of the code in here, I’m
just trying to walk you through how this thing works. Matter of fact, I have
lifted the o/g idea from Github comments somewhere.</p>
<h2 id="whats-the-problem"><a aria-hidden="true" tabindex="-1" href="#whats-the-problem"><span class="icon icon-link"></span></a>What’s the problem?</h2>
<p>I have all my posts in isolated markdown files, and I want them to know nothing
of the application that renders them. It works fine by the most part, the
<a href="https://mdsvex.pngwn.io" rel="nofollow">mdsvex</a> plugin imports and preprocesses the markdown
files just fine. It’s actually pretty darn great at it.</p>
<p>The thing is though, it doesn’t really preprocess the front-matter metadata. And
that’s a problem for me because I want to specify thumbnail images for my
articles, and I want those images to be processed by the svelte/vite pipelines
like everything else:</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">---
title: My article
thumbnail: ./local-image.jpg
...
---</code><!-- HTML_TAG_END --></pre>
<p>I could in theory just use mdsvex for what it was designed for and just import
the image in an embedded script like so:</p>
<pre class="language-md"><!-- HTML_TAG_START --><code class="language-md"><span class="token front-matter-block"><span class="token punctuation">---</span>
<span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> My article
<span class="token punctuation">...</span></span>
<span class="token punctuation">---</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    import thumb from "./local-image.jpg"
    metadata.thumbnail = thumb;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

the post text</code><!-- HTML_TAG_END --></pre>
<p>Call me pedantic, but, I don’t like the idea because it breaks the idea of
keeping my markdown files agnostic from the application. Adn it’s likely to
become a problem down the road when I decide to publish those articles somewhere
else.</p>
<p>So, I wanted some magic thing that would pre-process those markdown files for me
and make them compatible with the svelte/vite ecosystem without me touching the
files. And so enter the svelte plugins ecosystem.</p>
<h2 id="svelte-pre-processing-plugins"><a aria-hidden="true" tabindex="-1" href="#svelte-pre-processing-plugins"><span class="icon icon-link"></span></a>Svelte pre-processing plugins</h2>
<p>When you look inside of your <code>svelte.config.js</code> file you will see the
<code>preprocessors</code> section:</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">preprocessors</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token function">sveltePreprocess</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">vitePreprocess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mdsvex</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// ....</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>What those plugins do is they, well, preprocess the source code files that are
being imported into the application <em>before</em> they are finally imported and
initialized.</p>
<p>Think of this as basically meta programming, it’s a way to modify the source
code and possibly generate more code before a module is fully initialised.
That’s what <code>mdsvex</code> does in a nut shell, they turn the original markdown file
into basically a <code>.svelte</code> file which then can be imported by the svelte/vite
ecosystem as a regular module.</p>
<h2 id="how-does-it-work"><a aria-hidden="true" tabindex="-1" href="#how-does-it-work"><span class="icon icon-link"></span></a>How does it work?</h2>
<p>It works quite simple on the inside, a preprocessor plugin is basically an async
function that receives a file name and content, and returns modified version of
the code and a source map of the changes.</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token keyword">const</span> myPlugin <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">markup</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> content<span class="token punctuation">,</span> filename <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// do your thing here</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">code</span><span class="token operator">:</span> newContentString<span class="token punctuation">,</span>
      <span class="token literal-property property">map</span><span class="token operator">:</span> theSourceMapOfChanges<span class="token punctuation">,</span> <span class="token comment">// optional</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre>
<p>Once you have that, you can just plug it into the <code>preprocessors</code> list in the
<code>svelte.conf.js</code> file and it will dutifully shovel everything that’s being
imported into the application through your function.</p>
<p>To mess with the original content, svelte also has some handy functions to parse
the content into an AST and traverse the tree. Svelte is pretty dope like that.</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> parse<span class="token punctuation">,</span> walk <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"svelte/compiler"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myPlugin <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">markup</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> content<span class="token punctuation">,</span> filename <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> filename <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">walk</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>module<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// do your thing here</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">code</span><span class="token operator">:</span> newContentString<span class="token punctuation">,</span>
      <span class="token literal-property property">map</span><span class="token operator">:</span> theSourceMapOfChanges<span class="token punctuation">,</span> <span class="token comment">// optional</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre>
<p>You probably don’t want to edit the original content manually, though. And
instead use something like the
<a href="https://www.npmjs.com/package/magic-string" rel="nofollow">magic-string</a> package to safely
edit your codebase, and generate the source-map for your changes. Like so:</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> parse<span class="token punctuation">,</span> walk <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"svelte/compiler"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> MagicString <span class="token keyword">from</span> <span class="token string">"magic-string"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myPlugin <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">markup</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> content<span class="token punctuation">,</span> filename <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> filename <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">walk</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>module<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// do your thing here</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">code</span><span class="token operator">:</span> s<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">map</span><span class="token operator">:</span> s<span class="token punctuation">.</span><span class="token function">generateMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre>
<h2 id="an-example"><a aria-hidden="true" tabindex="-1" href="#an-example"><span class="icon icon-link"></span></a>An example</h2>
<p>I have my little thumbnail preprocessing function plugged in <em>after</em> the mdsvex
does its thing. Meaning it sees an already processed markdown file that was
turned into a <code>.svelte</code> file. And at the header of it will have a module
declaration string that looks like so:</p>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">export</span> <span class="token keyword">const</span> metadata <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"My article"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">"Blah blah blah"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">thumbnail</span><span class="token operator">:</span> <span class="token string">"./local-image.jpg"</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

the rest of the content</code><!-- HTML_TAG_END --></pre>
<p>What I want my plugin to do is to find that <code>metadata</code> const declaration and
replace it with a svelte native image import; preferably with the imagetools
optimisation parameters.</p>
<p>To that end, I’m using the svelte’s built in AST parser and walker; and then I
use the <code>magic-string</code> to safely patch the declaration.</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token function">walk</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>module<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// finding the &#96;metadata&#96; const declaration</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"VariableDeclarator"</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"metadata"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> property <span class="token keyword">of</span> node<span class="token punctuation">.</span>init<span class="token punctuation">.</span>properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// finding the &#96;thumbnail&#96; property</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>property<span class="token punctuation">.</span>key<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">"thumbnail"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> importThumb <span class="token operator">=</span>
            <span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">import THUMBNAIL from "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>property<span class="token punctuation">.</span>value<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">?w=1200&amp;h=600&amp;metadata";</span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">;</span>

          <span class="token comment">// adding the native thumb import to the source code</span>
          s<span class="token punctuation">.</span><span class="token function">appendLeft</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>module<span class="token punctuation">.</span>content<span class="token punctuation">.</span>start<span class="token punctuation">,</span> importThumb<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// replacing the o/g path with the new imported variable name</span>
          s<span class="token punctuation">.</span><span class="token function">overwrite</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>value<span class="token punctuation">.</span>start<span class="token punctuation">,</span> property<span class="token punctuation">.</span>value<span class="token punctuation">.</span>end<span class="token punctuation">,</span> <span class="token string">"THUMBNAIL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre>
<p>And that’s all there is to it. In the end this plugin will produce a <code>.svelte</code>
file that looks somewhat like this:</p>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token constant">THUMBNAIL</span> <span class="token keyword">from</span> <span class="token string">"./local-image.jpg?w=1200&amp;h=600&amp;metadata"</span><span class="token punctuation">;</span>

    <span class="token keyword">export</span> <span class="token keyword">const</span> metadata <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"My article"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">"Blah blah blah"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">thumbnail</span><span class="token operator">:</span> <span class="token constant">THUMBNAIL</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

the rest of the content</code><!-- HTML_TAG_END --></pre>
<p>And so, when the file is finally imported by svelte it will have the <code>thumbnail</code>
property on the <code>metadata</code> export. And that <code>thumbnail</code> will be a regular Svelte
image import. Which, you can then use normally anywhere in the app, for example
add it to the open graph meta tags like so:</p>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">export</span> <span class="token keyword">const</span> post<span class="token punctuation">;</span> <span class="token comment">// &lt;- the imported .md post</span>

    <span class="token literal-property property">$</span><span class="token operator">:</span> thumb <span class="token operator">=</span> post<span class="token punctuation">.</span>thumbnail<span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">svelte:</span>head</span><span class="token punctuation">></span></span>
<span class="token language-javascript"><span class="token punctuation">&#123;</span>#<span class="token keyword">if</span> thumb<span class="token punctuation">&#125;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>og:image<span class="token punctuation">"</span></span> <span class="token attr-name">content=</span><span class="token language-javascript"><span class="token punctuation">&#123;</span>thumb<span class="token punctuation">.</span>src<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>og:image:width<span class="token punctuation">"</span></span> <span class="token attr-name">content=</span><span class="token language-javascript"><span class="token punctuation">&#123;</span>Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>thumb<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>og:image:height<span class="token punctuation">"</span></span> <span class="token attr-name">content=</span><span class="token language-javascript"><span class="token punctuation">&#123;</span>Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>thumb<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span>
<span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token punctuation">&#125;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">svelte:</span>head</span><span class="token punctuation">></span></span></code><!-- HTML_TAG_END --></pre>
<p>And that’s pretty much the whole story. Enjoy!</p></div></article></main>

<footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pt-20 pb-4 text-center align-top text-gray-500 sm:flex-row sm:justify-between sm:text-xs"><div class="mr-0 sm:mr-4">Copyright © 2025 Kai Evans
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500"><a href="/" class="px-4 py-2 sm:py-0 sm:px-2 sm:hover:text-textColor sm:hover:underline no-underline">Home</a>
        <a href="/about" class="px-4 py-2 sm:py-0 sm:px-2 sm:hover:text-textColor sm:hover:underline no-underline">About</a>
        <a href="/posts" class="px-4 py-2 sm:py-0 sm:px-2 sm:hover:text-textColor sm:hover:underline no-underline">Log</a></nav></footer>


		<script type="module" data-sveltekit-hydrate="1q751ue">
			import { start } from "../_app/immutable/start-9d59f3a8.js";

			start({
				assets: "",
				env: {},
				target: document.querySelector('[data-sveltekit-hydrate="1q751ue"]').parentNode,
				version: "1740048292924",
				hydrate: {
					node_ids: [0, 6],
					data: [null,null],
					form: null,
					error: null
				}
			});
		</script>
	</div>
</body>

</html>