<!DOCTYPE html>
<html lang="en">

<head>
	<title>Kai Evans in writing</title>
	<meta charset="utf-8" />
	<link rel="icon" href="../favicon.png" />
	<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<script>
		const storedTheme =
			typeof localStorage !== "undefined"
				? localStorage.getItem("theme")
				: null;

		const prefersDark = window.matchMedia(
			"(prefers-color-scheme: dark)"
		).matches;

		if (storedTheme === "dark" || (!storedTheme && prefersDark)) {
			document.documentElement.classList.add("dark");
		}
	</script>
	<meta http-equiv="content-security-policy" content="">
		<link href="../_app/immutable/assets/_layout-26efa887.css" rel="stylesheet">
		<link href="../_app/immutable/assets/_page-5c045b07.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/start-b02a4349.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index-920be987.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/singletons-59e463da.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/preload-helper-41c905a7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/control-e7f5239e.js">
		<link rel="modulepreload" href="../_app/immutable/components/pages/_layout.svelte-45a685b0.js">
		<link rel="modulepreload" href="../_app/immutable/modules/pages/_layout.ts-9cbb603b.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_layout-da46b06b.js">
		<link rel="modulepreload" href="../_app/immutable/components/pages/posts/_...slug_/_page.svelte-df4f18c3.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Date-75465d9b.js">
		<link rel="modulepreload" href="../_app/immutable/modules/pages/posts/_...slug_/_page.ts-d5eccbfa.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index-4d8f42c1.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/posts-bda7ed56.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_page-12526a6c.js"><title>MetalLB in a homelab explainer ⁍ Kai Evans</title><!-- HEAD_svelte-1ijfm1m_START --><meta name="title" content="MetalLB in a homelab explainer ⁍ Kai Evans"><meta name="description" content="A bit of an explanation of how MetalLB works and what it does in a bare metal homelab setup. And how to use that with microk8s more specifically"><meta name="author" content="Kai Evans"><meta property="og:type" content="article"><meta property="og:title" content="MetalLB in a homelab explainer ⁍ Kai Evans"><meta property="og:description" content="A bit of an explanation of how MetalLB works and what it does in a bare metal homelab setup. And how to use that with microk8s more specifically"><meta property="og:url" content="http://kaievans.co/posts/c087r"><meta property="og:site_name" content="Kai Evans in writing"><meta property="og:image" content="/_app/immutable/assets/face-138fa419.jpeg"><meta property="og:image:width" content="800"><meta property="og:image:height" content="600"><meta property="article:author" content="Kai Evans"><meta property="article:published_time" content="2024-11-19T13:00:00.000Z"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="http://kaievans.co/posts/c087r"><meta property="twitter:title" content="MetalLB in a homelab explainer ⁍ Kai Evans"><meta property="twitter:description" content="A bit of an explanation of how MetalLB works and what it does in a bare metal homelab setup. And how to use that with microk8s more specifically"><meta property="twitter:image" content="/_app/immutable/assets/face-138fa419.jpeg"><!-- HEAD_svelte-1ijfm1m_END -->
</head>

<body data-sveltekit-preload-data="hover">
	<div style="display: contents;">


<header class="group relative mb-12 flex items-center sm:pl-[4.5rem]"><div class="flex sm:flex-col"><a href="/" class="inline-flex items-center sm:relative sm:inline-block" aria-current="page"><img src="/_app/immutable/assets/face-6c9b604a.webp" class="w-14 h-14 rounded mr-3 sm:absolute sm:left-[-4.5rem] sm:mr-0" alt="Kai Evans face">
            <span class="text-xl font-bold sm:text-2xl">Kai Evans</span></a>

        <nav class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-[color:var(--theme-menu-bg)] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:mt-1 sm:-ml-4 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dotted sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none" aria-label="Main menu"><a href="/" class="py-4 px-4 sm:py-0 sm:hover:underline" aria-current="page" rel="prefetch">Home</a>
            <a href="/about" class="py-4 px-4 sm:py-0 sm:hover:underline" aria-current="false" rel="prefetch">About</a>
            <a href="/posts" class="py-4 px-4 sm:py-0 sm:hover:underline" aria-current="false" rel="prefetch">Log</a></nav></div>
    <button type="button" class="group relative ml-auto h-9 w-9 rounded-md bg-zinc-200 p-2 ring-zinc-400 transition-all hover:ring-2 dark:bg-zinc-700" aria-label="Toggle Dark Mode"><svg id="sun-svg" class="absolute top-1/2 left-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all group-aria-pressed:scale-100 group-aria-pressed:opacity-100" aria-hidden="true" focusable="false" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    <svg id="moon-svg" class="absolute top-1/2 left-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all group-aria-[pressed=false]:scale-100 group-aria-[pressed=false]:opacity-100" aria-hidden="true" focusable="false" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"></circle><path d="M7.63262 3.06689C8.98567 3.35733 9.99999 4.56025 9.99999 6.00007C9.99999 7.65693 8.65685 9.00007 6.99999 9.00007C5.4512 9.00007 4.17653 7.82641 4.01685 6.31997" stroke="currentColor" stroke-width="1.5"></path><path d="M22 13.0505C21.3647 12.4022 20.4793 12 19.5 12C17.567 12 16 13.567 16 15.5C16 17.2632 17.3039 18.7219 19 18.9646" stroke="currentColor" stroke-width="1.5"></path><path d="M14.5 8.51L14.51 8.49889" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M10 17C11.1046 17 12 16.1046 12 15C12 13.8954 11.1046 13 10 13C8.89543 13 8 13.8954 8 15C8 16.1046 8.89543 17 10 17Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></header>

<main><article>
    
    
    
    

    <h1 class="title">MetalLB in a homelab explainer</h1>
<time datetime="2024-11-19T13:00:00.000Z" class="">20 November 2024</time>

<div class="inline before:content-['|']"><svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" class="inline-block h-6 w-6 ml-1" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path><path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path><path d="M6 9h-.01"></path></svg>
        <a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag homelab" href="/tags/homelab">homelab</a>, <a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag kubernetes" href="/tags/kubernetes">kubernetes</a>, <a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag networks" href="/tags/networks">networks</a>, <a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag engineering" href="/tags/engineering">engineering</a></div>

    <div class="mt-8 prose prose-sm prose-cactus prose-headings:font-semibold prose-headings:before:absolute prose-headings:before:-ml-4 prose-headings:before:text-accent prose-headings:before:content-['#'] prose-th:before:content-none"><p>My homelab setup runs on several mini PCs. Which, I guess, qualifies for a bare metal deployment. In a commercial cloud provider infrastructure this topic doesn’t particularly matter, but in a physical homelab setup, once you have more that one machine things get interesting.</p>
<p>It took me a bit of time to figure out the pieces, and I’m basically taking notes here before I forgot everything. But, I also hope it might come handy to someone else too.</p>
<h2 id="what-is-metallb-and-why-you-need-one"><a aria-hidden="true" tabindex="-1" href="#what-is-metallb-and-why-you-need-one"><span class="icon icon-link"></span></a>What is MetalLB and why you need one?</h2>
<p>Well, okay, in the most basic setup, one doesn’t actually need a load balancer. If all you want is to run some web services on port 80/443 and you don’t mind an occasional reboot, you can get away with just an ingress controller that listens on a <code>NodePort</code> and directs traffic to the right services based on DNS names. As long as the node that the ingress <code>externalIP</code> is bound to is up an running you will be fine.</p>
<p>There are several scenarios where that is not enough though. For example you want a failover in case the main node goes offline. Or, you’d like to actually load balance work between several physical nodes. Or, you might have services in your kubernetes setup that have to talk on the same port externally.</p>
<p>The problem with kubernetes is that it can do load balancing <em>internally</em> between pods via <code>kube-proxy</code>, that’s the job of services. But, it doesn’t have load balancing capabilities from the external network perspective. Instead, kubernetes integrates with external infrastructure for that. All cloud providers would normally do that out of the box.</p>
<p>And so, for example, when we mark a service as <code>spec.type: LoadBalancer</code>, that service will ask an external load balancer to assign it an external IP address for the service. If there is no such thing, like in a default homelab bare metal deployment, then the external IP will forever stuck in the “pending” state.</p>
<p>The usual workaround for that is to assign <code>externalIPs</code> for a service manually and make it talk on the host IP address. That will work for the most simple single node kubernetes setups without high availability features. But, it’s not entirely workable for more complex deployments.</p>
<p>And that is what MetalLB does. It is a super low overhead local network load balancer that performs the same role as a more sophisticated load balancing hardware would have in a commercial cloud infrastructure provider.</p>
<h2 id="how-does-metallb-work"><a aria-hidden="true" tabindex="-1" href="#how-does-metallb-work"><span class="icon icon-link"></span></a>How does MetalLB work?</h2>
<p>There are multiple ways to setup MetalLB. But, in a most basic scenario MetalLB will be configured with a pre-defined IP range, and it will allocate those IPs to kubernetes services as they come online.</p>
<p>What essentially happens is that MetalLB will advertise all those allocated external IP addresses on the host network interfaces using the L2 ARP protocol. From the external network perspective the host will still have a single IP, but it will advertise to ether devices in the same subnet that it responds to other IP addresses too. The easiest way to think about it is that it’s like a machine that has multiple IP addresses: the original host IP, plus all the additional IPs that MetalLB handles.</p>
<p>Then, as the traffic comes into the node it will be directed to services associated with those IP addresses. And after that the traffic will be load balanced internally via <code>kube-proxy</code> as it would in a basic kubernetes setup.</p>
<p>It brings couple of important advantages. Firstly, there can be multiple IP addresses attached to different services, each of them is different from the actual host IP address. Meaning services technically can talk on conflicting ports on the same physical machine. Also, if the node suddenly becomes unavailable, metallb will shift those IPs to another available node and the system will continue to operate.</p>
<p>This is called an L2 mode load balancer, and technically it is more like a failover rather than a true network level load balancing implementation since the actual load balancing between the pods will still be done horizontally inside kubernetes by <code>kube-proxy</code> that runs services.</p>
<p>Additionally, MetalLB can be configured in BGP mode which integrates with a router on the network. In this case, <em>all</em> nodes in the cluster will advertise the same set of IP addresses and the network router can properly load balance traffic directly to specific nodes. There also would be no failover latency involved in this case; the moment a node goes offline the router stops directing the traffic to that node and keeps feeding traffic other nodes instead.</p>
<p>Admittedly a BGP setup is way more complex that I would ever need in a homelab setup, and frankly it’s way over my head in terms of networks knowledge. So, I’ll stick to a default L2 setup in the chapter below.</p>
<h2 id="how-to-setup-metallb-in-microk8s"><a aria-hidden="true" tabindex="-1" href="#how-to-setup-metallb-in-microk8s"><span class="icon icon-link"></span></a>How to setup MetalLB in microk8s</h2>
<p>For all the lengthly preamble above, setting up metallb in ubuntu/microk8s environment is actually dead simple. It’s just one command:</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">sudo microk8s enable metallb</code><!-- HTML_TAG_END --></pre>
<p>When you run it, it will ask to give it an IP addresses range that it will later hand over to services. And that is a bit more complicated topic than the installation itself.</p>
<p>Long story short, the way L2 IPs advertisement works, it only affects devices within the same subnetwork. Most household routers would have their DHCP setup to the <code>192.168.XXX.*</code> range with a net mask set to <code>255.255.255.0</code>. Meaning that only the devices with IPs within the <code>192.168.XXX.*</code> range will see the L2 addresses advertisement.</p>
<p>For example if the router network works with the <code>192.168.66.*</code> range, the IP addresses that you give to MetalLB will have to come from that same range. Using say <code>192.168.67.*</code> won’t work. I mean, technically it could, say if you set your net mask to <code>255.255.0.0</code>, but that’s a whole another can of worms that I don’t want to open.</p>
<p>The easiest way to set it up is to basically limit DHCP range to say <code>192.168.66.1 ... 192.168.66.200</code> and give the rest <code>55</code> addresses to MetalLB. Although, frankly you won’t need <code>55</code> addresses, you might only use a hand full of them at best, the web ingress controller will only need one and that will probably cover <code>95%</code> of your use cases.</p>
<p>And that’s more or less that. MetalLB will automatically distribute those IPs to interested services and advertise them to the network. And in case if you’d want to have a predefined IP, say for DNS purposes, you can make the service to ask for that specific address. Here for example my nginx ingress service.</p>
<pre class="language-yaml"><!-- HTML_TAG_START --><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>microk8s
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
  <span class="token key atrule">loadBalancerIP</span><span class="token punctuation">:</span> 192.168.88.44</code><!-- HTML_TAG_END --></pre>
<p>Now, regardless which node actually advertises the IPs, all the port 80/443 traffic hitting that IP address will be directed into my nginx ingress service. Also, it won’t interfere with the actual physical machine IP that my router’s DHCP server assigned to it. Pretty neat, isn’t it?</p>
<p>And that’s all there is to it. It’s not all that complicated as it seemed initially.</p></div></article></main>

<footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pt-20 pb-4 text-center align-top text-gray-500 sm:flex-row sm:justify-between sm:text-xs"><div class="mr-0 sm:mr-4">Copyright © 2025 Kai Evans
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500"><a href="/" class="px-4 py-2 sm:py-0 sm:px-2 sm:hover:text-textColor sm:hover:underline no-underline">Home</a>
        <a href="/about" class="px-4 py-2 sm:py-0 sm:px-2 sm:hover:text-textColor sm:hover:underline no-underline">About</a>
        <a href="/posts" class="px-4 py-2 sm:py-0 sm:px-2 sm:hover:text-textColor sm:hover:underline no-underline">Log</a></nav></footer>


		<script type="module" data-sveltekit-hydrate="bsiibw">
			import { start } from "../_app/immutable/start-b02a4349.js";

			start({
				assets: "",
				env: {},
				target: document.querySelector('[data-sveltekit-hydrate="bsiibw"]').parentNode,
				version: "1739782262527",
				hydrate: {
					node_ids: [0, 6],
					data: [null,null],
					form: null,
					error: null
				}
			});
		</script>
	</div>
</body>

</html>